<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Task Manager</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-robot"></i>
            <span>TaskAI</span></div>
          

        </div>
        <ul class="nav-links">
            <li>
                <a href="#" class="nav-link active" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-page="tasks">
                    <i class="fas fa-tasks"></i>
                    <span>Tasks</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-page="chat">
                    <i class="fas fa-comment"></i>
                    <span>Talk to AI</span>
                </a>
            </li>
            
        </ul>
    </nav>

    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Page -->
        <section id="dashboard-page" class="page active">
            <div class="dashboard-header">
                <h1>Task Dashboard</h1>
                <p>Overview of your tasks and productivity</p>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon pending">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="pending-count">0</h3>
                        <p>In Progress</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon completed">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="completed-count">0</h3>
                        <p>Completed Tasks</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon not-started">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="not-started-count">0</h3>
                        <p>Not Started</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon urgent">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="urgent-count">0</h3>
                        <p>Urgent Tasks</p>
                    </div>
                </div>
            </div>

           

            <!-- Upcoming Deadlines -->
            <div class="chart-container">
                <h3>Upcoming Deadlines</h3>
                <div id="upcoming-deadlines" class="deadlines-list">
                    <div class="loading">Loading deadlines...</div>
                </div>
            </div>
        </section>

        <!-- Tasks Page -->
        <section id="tasks-page" class="page">
            <div class="tasks-header">
                <h1>All Tasks</h1>
                <div class="filter-controls">
                    <button class="filter-btn active" data-filter="all">All</button>
                  
        
                    <button class="filter-btn" data-filter="High">High Priority</button>
                    <button class="filter-btn" data-filter="Medium">Medium Priority</button>
                    <button class="filter-btn" data-filter="Low">Low Priority</button>
                </div>
            </div>

            <div class="tasks-grid">
                <!-- Not Started Column -->
                <div class="task-column" data-status="Not Started">
                    <div class="column-header">
                        <h3>
                            <i class="fas fa-plus-circle"></i>
                            Not Started
                            
                        </h3>
                    </div>
                    <div class="task-list" id="not-started-tasks">
                        <div class="loading">Loading tasks...</div>
                    </div>
                </div>

                <!-- In Progress Column -->
                <div class="task-column" data-status="Pending">
                    <div class="column-header">
                        <h3>
                            <i class="fas fa-clock"></i>
                            In Progress
                            
                        </h3>
                    </div>
                    <div class="task-list" id="pending-tasks">
                        <div class="loading">Loading tasks...</div>
                    </div>
                </div>

                <!-- Completed Column -->
                <div class="task-column" data-status="Completed">
                    <div class="column-header">
                        <h3>
                            <i class="fas fa-check-circle"></i>
                            Completed
                            
                        </h3>
                    </div>
                    <div class="task-list" id="completed-tasks">
                        <div class="loading">Loading tasks...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Chat Page -->
        <section id="chat-page" class="page">
            <div class="chat-container">
                <div class="chat-header">
                    <h2><i class="fas fa-robot"></i> AI Task Assistant</h2>
                    <p>Chat with the AI to add, manage, and organize your tasks</p>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <div class="message ai">
                        <div class="message-text">
                            Hello! I'm your AI Task Assistant. I can help you:
                            <br>‚Ä¢ Add new tasks to your list
                            <br>‚Ä¢ Organize tasks by priority
                            <br>‚Ä¢ Set deadlines and reminders
                            <br>‚Ä¢ Track your progress
                            <br><br>Try saying: "Add a task to complete the report by tomorrow with high priority"
                        </div>
                        <div class="message-time">Just now</div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" 
                           class="chat-input" 
                           id="chat-input" 
                           placeholder="Type your message here...">
                    <button class="send-btn" id="send-btn">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </section>
    </main>



    <script src="script.js"></script>


    <script>
// Global Variables
let currentPage = 'dashboard';
let tasks = [];
let notifications = [];
let notificationCheckInterval;

// DOM Elements
const pages = {
    dashboard: document.getElementById('dashboard-page'),
    tasks: document.getElementById('tasks-page'),
    chat: document.getElementById('chat-page')
};

// Initialize the application
document.addEventListener('DOMContentLoaded', () => {
    // Check authentication FIRST
    const userId = localStorage.getItem('user_id');
    if (!userId) {
        window.location.href = '/login';
        return;
    }
    
    // Load user info
    const userName = localStorage.getItem('user_name');
    const userEmail = localStorage.getItem('user_email');
    const userPicture = localStorage.getItem('user_picture');
    
    // Update user display
    if (userName && document.getElementById('user-name')) {
        document.getElementById('user-name').textContent = userName;
    }
    if (userPicture && document.getElementById('user-avatar')) {
        document.getElementById('user-avatar').src = userPicture;
    }
    
    // Initialize app
    initNavigation();
    loadDashboard();
    checkForNotifications();
    
    // Check for notifications every 30 seconds
    notificationCheckInterval = setInterval(checkForNotifications, 30000);
    
    // Initialize charts (will be loaded when dashboard is shown)
    if (window.Chart) {
        initCharts();
    }
    
    // Logout button
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '/login';
        });
    }
});

// Navigation Functions
function initNavigation() {
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const page = link.dataset.page;
            switchPage(page);
        });
    });
    
    // Set dashboard as active by default
    switchPage('dashboard');
}

function switchPage(page) {
    // Update active page
    currentPage = page;
    
    // Update navigation
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.dataset.page === page) {
            link.classList.add('active');
        }
    });
    
    // Show/hide pages
    Object.keys(pages).forEach(key => {
        if (key === page) {
            if (pages[key]) pages[key].classList.add('active');
        } else {
            if (pages[key]) pages[key].classList.remove('active');
        }
    });
    
    // Load page-specific content
    switch(page) {
        case 'dashboard':
            loadDashboard();
            break;
        case 'tasks':
            loadTasks();
            break;
        case 'chat':
            loadChat();
            break;
    }
}














<!-- --- Front-end: Add/replace these helper functions -->

// --- Robust date parser for DB timestamps (handles "YYYY-MM-DD HH:MM:SS" and ISO variants) ---
function parseToDate(input) {
  if (!input && input !== 0) return null;
  if (input instanceof Date) return isNaN(input) ? null : input;

  // numeric timestamp (ms)
  if (typeof input === 'number' || /^\d+$/.test(String(input))) {
    const n = Number(input);
    const d = new Date(n);
    return isNaN(d) ? null : d;
  }

  let s = String(input).trim();

  // If already ISO-like (contains 'T') or has timezone indicator (Z or +hh:mm / -hh:mm) use as-is
  const hasT = s.includes('T');
  const hasZ = /Z$/i.test(s);
  const hasTZoffset = /[+\-]\d{2}:\d{2}$/.test(s);

  if (!hasT && !hasZ && !hasTZoffset) {
    // Convert "YYYY-MM-DD HH:MM:SS" -> "YYYY-MM-DDTHH:MM:SSZ"
    if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}(:\d{2})?$/.test(s)) {
      s = s.replace(/\s+/, 'T');
      if (!s.endsWith('Z')) s = s + 'Z';
    } else if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
      // date-only -> UTC midnight
      s = s + 'T00:00:00Z';
    } else {
      // fallback: replace first space with 'T' and append Z if no timezone
      s = s.replace(/\s+/, 'T');
      if (!/[Z+\-]\d{2}/.test(s)) s = s + 'Z';
    }
  }

  const d = new Date(s);
  return isNaN(d) ? null : d;
}

// --- UTC date-only ms (midnight UTC) ---
function utcDateOnlyMs(d) {
  return Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
}

// --- Returns integer days remaining: (dueDate - today) in UTC days
// 0 = due today, positive = days until due, negative = overdue
function getDaysRemaining(dateString) {
  const date = parseToDate(dateString);
  if (!date) return null;
  const now = new Date();
  const msPerDay = 24 * 60 * 60 * 1000;
  const diff = Math.floor((utcDateOnlyMs(date) - utcDateOnlyMs(now)) / msPerDay);
  return diff;
}

// --- formatDate: uses UTC day-only comparison
function formatDate(dateString) {
  if (!dateString) return 'No date';
  const date = parseToDate(dateString);
  if (!date) return 'Invalid date';
  const now = new Date();
  const msPerDay = 24 * 60 * 60 * 1000;
  const diffDays = Math.floor((utcDateOnlyMs(now) - utcDateOnlyMs(date)) / msPerDay);

  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays > 1 && diffDays < 7) return `${diffDays} days ago`;

  // Older: readable date (display in user's locale)
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: date.getUTCFullYear() !== now.getUTCFullYear() ? 'numeric' : undefined
  });
}



function updateDashboardStats(stats) {
    // Update stat cards
    if (document.getElementById('pending-count')) 
        document.getElementById('pending-count').textContent = stats.byStatus['Pending'] || 0;
    if (document.getElementById('completed-count')) 
        document.getElementById('completed-count').textContent = stats.byStatus['Completed'] || 0;
    if (document.getElementById('not-started-count')) 
        document.getElementById('not-started-count').textContent = stats.byStatus['Not Started'] || 0;
    if (document.getElementById('urgent-count')) 
        document.getElementById('urgent-count').textContent = stats.urgent || 0;
    
    // Update upcoming deadlines
    const deadlinesList = document.getElementById('upcoming-deadlines');
    if (!deadlinesList) return;
    
    deadlinesList.innerHTML = '';
    
    if (stats.upcomingDeadlines && stats.upcomingDeadlines.length > 0) {
        stats.upcomingDeadlines.forEach(task => {
            const daysRemaining = getDaysRemaining(task.DueDate);
            const item = document.createElement('div');
            item.className = 'deadline-item';
            const dayLabel = (daysRemaining === 0) ? 'today' :
                             (daysRemaining < 0) ? `${Math.abs(daysRemaining)} days ago` :
                             `${daysRemaining} ${Math.abs(daysRemaining) === 1 ? 'day' : 'days'}`;
            const urgentClass = (daysRemaining !== null && daysRemaining >= 0 && daysRemaining <= 2) ? 'urgent' : (daysRemaining < 0 ? 'overdue' : '');
            item.innerHTML = `
                <div class="deadline-title">${task.Title}</div>
                <div class="deadline-date ${urgentClass}">
                    ${formatDate(task.DueDate)} (${dayLabel})
                </div>
            `;
            deadlinesList.appendChild(item);
        });
    } else {
        deadlinesList.innerHTML = '<div class="no-deadlines">No upcoming deadlines</div>';
    }
}







// Dashboard Functions
async function loadDashboard() {
    try {
        const userId = localStorage.getItem('user_id');
        if (!userId) {
            window.location.href = '/login';
            return;
        }
        
        const response = await fetch(`/api/task-stats?user_id=${encodeURIComponent(userId)}`);
        const stats = await response.json();
        
        updateDashboardStats(stats);
        updateCharts(stats);
        updateNotifications(stats);
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showNotification('Failed to load dashboard data', 'error');
    }
}








function createTaskElement(task) {
    const div = document.createElement('div');
    div.className = `task-card priority-${task.Priority ? task.Priority.toLowerCase() : 'medium'}`;
    div.dataset.id = task.TaskID;
    div.draggable = true;

    const dueDateObj = task.DueDate ? parseToDate(task.DueDate) : null;
    const daysRemaining = dueDateObj !== null ? getDaysRemaining(task.DueDate) : null;
    
    // choose CSS class: overdue, urgent, or normal
    const dueClass = (daysRemaining === null) ? '' :
                     (daysRemaining < 0) ? 'overdue' :
                     (daysRemaining <= 2) ? 'urgent' : '';

    div.innerHTML = `
        <div class="task-header">
            <div>
                <div class="task-title">${task.Title || 'Untitled Task'}</div>
                ${task.Description ? `<div class="task-description">${task.Description}</div>` : ''}
            </div>
            <div class="task-priority">${getPriorityIcon(task.Priority)}</div>
        </div>
        <div class="task-footer">
            <div class="task-info">
                ${dueDateObj ? `<div class="task-due ${dueClass}">
                    ${formatDate(task.DueDate)} ${daysRemaining !== null ? `(${daysRemaining < 0 ? Math.abs(daysRemaining) + 'd ago' : daysRemaining === 0 ? 'today' : daysRemaining + 'd'})` : ''}
                </div>` : ''}
                <div class="task-created">Created: ${formatDate(task.CreatedAt)}</div>
            </div>
            <div class="task-actions">
                <button class="action-btn" onclick="updateTaskStatus(${task.TaskID}, 'Completed')" title="Mark as completed">
                    ‚úì
                </button>
                <button class="action-btn" onclick="deleteTask(${task.TaskID})" title="Delete task">
                    √ó
                </button>
            </div>
        </div>
    `;
    
    // Add drag and drop event listeners
    div.addEventListener('dragstart', handleDragStart);
    div.addEventListener('dragover', handleDragOver);
    div.addEventListener('drop', handleDrop);
    
    return div;
}


















// Tasks Functions
async function loadTasks() {
    try {
        const userId = localStorage.getItem('user_id');
        if (!userId) {
            window.location.href = '/login';
            return;
        }
        
        showLoading('tasks-container', 'Loading tasks...');
        
        const response = await fetch(`/api/tasks?user_id=${encodeURIComponent(userId)}`);
        tasks = await response.json();
        
        renderTasks();
        setupTaskFilters();
    } catch (error) {
        console.error('Error loading tasks:', error);
        showNotification('Failed to load tasks', 'error');
    }
}

function renderTasks(filter = 'all') {
    const taskLists = {
        'not-started': document.getElementById('not-started-tasks'),
        'pending': document.getElementById('pending-tasks'),
        'completed': document.getElementById('completed-tasks')
    };
    
    // Clear all task lists
    Object.values(taskLists).forEach(list => {
        if (list) list.innerHTML = '';
    });
    
    // Filter tasks
    let filteredTasks = tasks;
    if (filter !== 'all') {
        filteredTasks = tasks.filter(task => 
            filter === 'priority' ? task.Priority === filter : 
            filter === 'status' ? task.Status === filter : 
            task.Priority === filter
        );
    }
    
    // Group tasks by status
    const groupedTasks = {
        'Not Started': [],
        'Pending': [],
        'Completed': []
    };
    
    filteredTasks.forEach(task => {
        if (groupedTasks[task.Status]) {
            groupedTasks[task.Status].push(task);
        }
    });
    
    // Render tasks in each column
    Object.keys(groupedTasks).forEach(status => {
        const columnId = status.toLowerCase().replace(' ', '-');
        const taskList = taskLists[columnId];
        
        if (!taskList) return;
        
        if (groupedTasks[status].length === 0) {
            taskList.innerHTML = '<div class="no-tasks">No tasks in this category</div>';
            return;
        }
        
        groupedTasks[status].forEach(task => {
            const taskElement = createTaskElement(task);
            taskList.appendChild(taskElement);
        });
    });
    
    // Update task counts in dashboard if elements exist
    const notStartedCount = document.getElementById('not-started-count');
    const pendingCount = document.getElementById('pending-count');
    const completedCount = document.getElementById('completed-count');
    
    if (notStartedCount) notStartedCount.textContent = groupedTasks['Not Started'].length;
    if (pendingCount) pendingCount.textContent = groupedTasks['Pending'].length;
    if (completedCount) completedCount.textContent = groupedTasks['Completed'].length;
}



function getPriorityIcon(priority) {
    const icons = {
        'High': 'üî¥',
        'Medium': 'üü°',
        'Low': 'üü¢'
    };
    return icons[priority] || '‚ö™';
}

function setupTaskFilters() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderTasks(btn.dataset.filter);
        });
    });
}

// Task Management Functions
async function updateTaskStatus(taskId, status) {
    try {
        const userId = localStorage.getItem('user_id');
        if (!userId) {
            window.location.href = '/login';
            return;
        }
        
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ Status: status, user_id: userId })
        });
        
        if (response.ok) {
            showNotification('Task updated successfully', 'success');
            await loadTasks();
            await loadDashboard(); // Refresh dashboard stats
        }
    } catch (error) {
        console.error('Error updating task:', error);
        showNotification('Failed to update task', 'error');
    }
}

async function deleteTask(taskId) {
    if (!confirm('Are you sure you want to delete this task?')) return;
    
    try {
        const userId = localStorage.getItem('user_id');
        if (!userId) {
            window.location.href = '/login';
            return;
        }
        
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_id: userId })
        });
        
        if (response.ok) {
            showNotification('Task deleted successfully', 'success');
            await loadTasks();
            await loadDashboard(); // Refresh dashboard stats
        }
    } catch (error) {
        console.error('Error deleting task:', error);
        showNotification('Failed to delete task', 'error');
    }
}

// Drag and Drop Functions
let draggedTask = null;

function handleDragStart(e) {
    draggedTask = this;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
    this.classList.add('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    this.classList.add('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    this.classList.remove('drag-over');
    
    if (draggedTask !== this) {
        const newStatus = this.closest('.task-column').dataset.status;
        const taskId = draggedTask.dataset.id;
        
        updateTaskStatus(taskId, newStatus);
    }
}

// Chat Functions
let chatMessages = [];

function loadChat() {
    const chatMessagesDiv = document.getElementById('chat-messages');
    if (!chatMessagesDiv) return;
    
    chatMessagesDiv.innerHTML = '';
    
    // Load previous messages
    chatMessages.forEach(message => {
        addMessageToChat(message.text, message.sender, message.timestamp);
    });
    
    // Focus on input
    setTimeout(() => {
        const chatInput = document.getElementById('chat-input');
        if (chatInput) chatInput.focus();
    }, 100);
    
    // Setup send button and enter key
    const sendBtn = document.getElementById('send-btn');
    const chatInput = document.getElementById('chat-input');
    
    if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
    }
    if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    const sendBtn = document.getElementById('send-btn');
    
    if (!message) return;
    
    // Add user message to chat
    addMessageToChat(message, 'user');
    input.value = '';
    if (sendBtn) sendBtn.disabled = true;
    
    try {
        const userId = localStorage.getItem('user_id');
        if (!userId) {
            window.location.href = '/login';
            return;
        }
        
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message, user_id: userId })
        });
        
        const data = await response.json();
        
        // Extract AI response
        let aiResponse = '';
        if (Array.isArray(data) && data[0]?.output) {
            aiResponse = data[0].output;
        } else if (data.response) {
            aiResponse = data.response;
        } else if (typeof data === 'string') {
            aiResponse = data;
        } else {
            aiResponse = 'I received your message. Let me process that for you.';
        }
        
        // Add AI response to chat
        setTimeout(() => {
            addMessageToChat(aiResponse, 'ai');
            if (sendBtn) sendBtn.disabled = false;
            input.focus();
        }, 1000); // Simulate thinking time
    } catch (error) {
        console.error('Error sending message:', error);
        addMessageToChat('Sorry, I encountered an error. Please try again.', 'ai');
        if (sendBtn) sendBtn.disabled = false;
        input.focus();
    }
}

function addMessageToChat(text, sender, timestamp = new Date()) {
    const chatMessagesDiv = document.getElementById('chat-messages');
    if (!chatMessagesDiv) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const timeString = typeof timestamp === 'string' ? timestamp : 
        timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    messageDiv.innerHTML = `
        <div class="message-text">${formatMessage(text)}</div>
        <div class="message-time">${timeString}</div>
    `;
    
    chatMessagesDiv.appendChild(messageDiv);
    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    
    // Store message
    chatMessages.push({
        text,
        sender,
        timestamp: timeString
    });
    
    // Keep only last 50 messages
    if (chatMessages.length > 50) {
        chatMessages = chatMessages.slice(-50);
    }
}

function formatMessage(text) {
    // Convert URLs to links
    text = text.replace(
        /(https?:\/\/[^\s]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
    );
    
    // Convert newlines to <br>
    text = text.replace(/\n/g, '<br>');
    
    // Convert *bold* to <strong>
    text = text.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
    
    return text;
}

// Notification Functions
async function checkForNotifications() {
    try {
        const userId = localStorage.getItem('user_id');
        if (!userId) return;
        
        const response = await fetch(`/api/notifications?user_id=${encodeURIComponent(userId)}`);
        notifications = await response.json();
        
        // Update notification badge
        const badge = document.getElementById('notification-badge');
        if (badge) {
            if (notifications.length > 0) {
                badge.textContent = notifications.length;
                badge.style.display = 'inline-block';
                
                // Show desktop notifications if granted permission
                if (Notification.permission === 'granted') {
                    showDesktopNotifications(notifications);
                }
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Show in-app notifications
        showInAppNotifications(notifications);
    } catch (error) {
        console.error('Error checking notifications:', error);
    }
}

function showInAppNotifications(notifications) {
    const container = document.getElementById('notification-container');
    if (!container) return;
    
    // Clear old notifications
    container.innerHTML = '';
    
    // Show only the 3 most recent notifications
    notifications.slice(0, 3).forEach(notification => {
        const notificationDiv = document.createElement('div');
        notificationDiv.className = `notification ${notification.type}`;
        notificationDiv.innerHTML = `
            <div class="notification-icon">
                ${notification.type === 'urgent' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
            </div>
            <div class="notification-content">
                <div class="notification-message">${notification.message}</div>
                <div class="notification-task">${notification.Title}</div>
            </div>
            <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
        `;
        
        container.appendChild(notificationDiv);
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (notificationDiv.parentElement) {
                notificationDiv.remove();
            }
        }, 10000);
    });
}

function showDesktopNotifications(notifications) {
    notifications.forEach(notification => {
        new Notification('Task Reminder', {
            body: notification.message,
            icon: '/favicon.ico',
            tag: notification.TaskID
        });
    });
}

function requestNotificationPermission() {
    if (Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                console.log('Notification permission granted');
            }
        });
    }
}

// Utility Functions


function showNotification(message, type = 'info') {
    const container = document.getElementById('notification-container');
    if (!container) return;
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div class="notification-icon">
            ${type === 'success' ? '‚úì' : type === 'error' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
        </div>
        <div class="notification-message">${message}</div>
        <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    
    container.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

function showLoading(containerId, message = 'Loading...') {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <div>${message}</div>
        </div>
    `;
}

// Initialize notification permission on page load
if ('Notification' in window) {
    requestNotificationPermission();
}

// Export functions for HTML onclick events
window.updateTaskStatus = updateTaskStatus;
window.deleteTask = deleteTask;
window.sendMessage = sendMessage;
</script>
</body>
</html>