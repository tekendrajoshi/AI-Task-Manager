<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Login - TaskAI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="styles.css">
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
*{box-sizing:border-box;font-family:"Poppins",sans-serif}
body{background:linear-gradient(135deg,#2b1055,#0f0528);color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.login-container{width:380px;background:rgba(255,255,255,0.06);backdrop-filter:blur(10px);padding:32px;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.6);text-align:center}
.app-title{display:flex;flex-direction:column;align-items:center;gap:4px;margin-bottom:12px}
.app-title .title{font-size:28px;font-weight:700;background:linear-gradient(45deg,#00ffd5,#ff00c8);-webkit-background-clip:text;background-clip:text;color:transparent}
.app-title .subtitle{font-size:12px;font-style:italic;color:rgba(255,255,255,0.75)}
h2{margin:6px 0 18px;font-size:20px}
.form-box{background:rgba(0,0,0,0.18);padding:14px;border-radius:12px;margin-bottom:14px;text-align:left}
.form-row{margin-bottom:12px}
label{display:block;font-size:13px;color:rgba(255,255,255,0.85);margin-bottom:6px}
input[type="email"],input[type="password"]{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);color:#fff}
button.primary{width:100%;padding:10px;border-radius:10px;border:0;background:linear-gradient(90deg,#00ffd5,#ff00c8);color:#111;font-weight:700;cursor:pointer}
.small-note{font-size:13px;margin-top:12px;color:rgba(255,255,255,0.8)}
.g_id_signin{margin-top:12px;display:flex;justify-content:center}
.error{color:#ff8aa1;margin-top:8px;font-size:13px}
</style>
</head>

<body>
<div class="login-container">
  <div class="app-title">
    <div class="title">TaskAI</div>
    <div class="subtitle">AI Task Manager</div>
  </div>

  <h2>Welcome Back</h2>

  <div class="form-box">
    <form id="manual-login-form">
      <div class="form-row">
        <label for="email">Email</label>
        <input id="email" name="email" type="email" required>
      </div>

      <div class="form-row">
        <label for="password">Password</label>
        <input id="password" name="password" type="password" required>
      </div>

      <button class="primary" type="submit">Sign in</button>
      <div id="login-error" class="error" style="display:none"></div>
    </form>
  </div>

  <div class="small-note">Or continue with</div>

  <!-- GOOGLE LOGIN BUTTON -->
  <div id="g_id_onload" data-client_id="" data-auto_prompt="false"></div>
  <div class="g_id_signin"
       data-type="standard"
       data-shape="rectangular"
       data-theme="outline"
       data-text="signin_with"
       data-size="large"
       data-logo_alignment="left"></div>

  <p class="small-note">Don't have an account?
     <a href="register.html" style="color:#00ffd5">Register</a></p>
</div>

<script>
function showError(msg){
  const el = document.getElementById('login-error');
  el.textContent = msg;
  el.style.display = msg ? 'block' : 'none';
}

// ------------------- MANUAL LOGIN -------------------
document.getElementById('manual-login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    showError('');

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    try {
        const response = await fetch('/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
            credentials: 'include'
        });

        const result = await response.json();

        if (result.success) {
            window.location.href = '/index.html';
        } else {
            showError(result.message || 'Login failed');
        }
    } catch (err) {
        showError('Network error.');
    }
});

// ------------------- GOOGLE LOGIN -------------------
function handleCredentialResponse(response) {
    fetch('/auth/google', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id_token: response.credential })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.href = '/index.html';
        } else {
            showError(data.message || 'Google login failed');
        }
    })
    .catch(() => showError('Google network error'));
}

// ------------------- LOAD CLIENT ID FROM BACKEND -------------------
window.onload = function(){
  fetch('/config')
    .then(res => res.json())
    .then(cfg => {
      google.accounts.id.initialize({
        client_id: cfg.GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse
      });
      google.accounts.id.renderButton(
        document.querySelector(".g_id_signin"),
        { theme:"outline", size:"large" }
      );
    })
    .catch(err => console.error("Config load failed", err));
};
</script>
</body>
</html>
